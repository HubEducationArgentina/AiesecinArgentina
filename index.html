<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Login - Plataforma Educativa</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#0f1724; color:#fff; }
    .card { background:#111827; padding:24px; border-radius:8px; width:360px; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    input { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #333; background:#0b1220; color:#fff; }
    button { width:100%; padding:10px; margin-top:8px; border:0; border-radius:6px; background:#0ea5e9; color:#042028; font-weight:600; cursor:pointer; }
    .error { color:#ffb4b4; margin-top:8px; font-size:0.95em; white-space:pre-wrap; }
    .info { color:#9fe3ff; font-size:0.85em; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Iniciar sesión</h2>

    <form id="loginForm" autocomplete="off">
      <label for="user">Usuario</label>
      <input id="user" name="user" type="text" placeholder="Tu usuario" required />

      <label for="pass">Contraseña</label>
      <input id="pass" name="pass" type="password" placeholder="Contraseña" required />

      <button type="submit" id="btnLogin">Entrar</button>
      <div id="error" class="error" aria-live="polite"></div>
      <div id="info" class="info"></div>
    </form>
  </div>

  <!-- Si usas users.js tipo global, incluye users.js antes de este script:
       <script src="users.js"></script>
       users.js puede definir window.USERS = [...]; 
  -->

  <script>
    document.getElementById('loginForm').addEventListener('submit', async function (ev) {
      ev.preventDefault();
      const btn = document.getElementById('btnLogin');
      const errEl = document.getElementById('error');
      const infoEl = document.getElementById('info');
      errEl.textContent = '';
      infoEl.textContent = '';

      const username = document.getElementById('user').value.trim();
      const password = document.getElementById('pass').value;

      if (!username || !password) {
        errEl.textContent = 'Por favor completa usuario y contraseña.';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Validando...';
      try {
        let users = null;
        // Intento 1: fetch a users.json (si existe y es accesible)
        try {
          const res = await fetch('users.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status + ' al cargar users.json');
          users = await res.json();
          console.log('users.json cargado correctamente:', users);
          infoEl.textContent = 'users.json cargado desde fetch.';
        } catch (fetchErr) {
          console.warn('No se pudo cargar users.json con fetch:', fetchErr.message);
          // Intento 2: fallback a variable global window.USERS (si users.js define esto)
          if (window.USERS && Array.isArray(window.USERS)) {
            users = window.USERS;
            console.log('Se usó window.USERS:', users);
            infoEl.textContent = 'Se usó window.USERS (users.js).';
          } else {
            // Intento 3: si users.js está escrito como módulo (export default), no se puede leer así.
            throw new Error('No se encontró users.json ni window.USERS. Asegura que users.json exista o que users.js defina window.USERS (no módulo).');
          }
        }

        // Validar formato
        if (!Array.isArray(users)) throw new Error('Formato inválido: users no es un arreglo.');

        // Buscar usuario (case-insensitive en username)
        const found = users.find(x => {
          const un = (x.username || '').toString();
          const pw = (x.password || '').toString();
          return un.toLowerCase() === username.toLowerCase() && pw === password;
        });

        if (!found) {
          errEl.textContent = 'Usuario o contraseña incorrectos.';
          console.log('Intento de login fallido para:', username);
          return;
        }

        // Guardar y redirigir
        localStorage.setItem('username', found.username);
        console.log('Login correcto. Usuario guardado en localStorage:', found.username);
        location.href = 'home.html';
      } catch (error) {
        console.error('Error durante login:', error);
        // Mostrar el mensaje de error completo para debug (safe: no exponer trazas remotas)
        errEl.textContent = 'Error al intentar iniciar sesión:\n' + (error && error.message ? error.message : String(error)) + '\n(Revisa la consola para más detalles).';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });
  </script>
</body>
</html>
